# ðŸ§© Step 1: Create a Node.js Repl, then paste all this into the shell or replit.nix setup
# After running, you'll have: index.html + script.js + server.js
# Then click "Run" to launch your app and open it in the browser

echo '{
  "name": "surveyjs-csv-linker",
  "version": "1.0.0",
  "main": "server.js",
  "type": "module",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "@replit/database": "^2.0.0",
    "body-parser": "^1.20.2",
    "express": "^4.18.2"
  }
}' > package.json

# ðŸ§  server.js â€“ backend
cat <<'EOF' > server.js
import express from "express";
import bodyParser from "body-parser";
import Database from "@replit/database";

const app = express();
const db = new Database();

app.use(bodyParser.json());
app.use(express.static(".")); // serve frontend files

app.post("/api/survey", async (req, res) => {
  const { uuid, display_text, all_responses } = req.body;

  await db.set(uuid, {
    display_text,
    all_responses,
    timestamp: new Date().toISOString()
  });

  console.log("âœ… Saved survey response:", uuid, display_text);
  res.json({ status: "saved", uuid });
});

app.listen(3000, () => console.log("ðŸš€ Server running on port 3000"));
EOF

# ðŸ§© index.html â€“ frontend UI
cat <<'EOF' > index.html
<!DOCTYPE html>
<html>
  <head>
    <title>Dynamic Survey Generator</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/survey-core/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-knockout-ui/survey.ko.min.js"></script>
  </head>
  <body style="font-family: sans-serif; margin: 2em;">
    <h2>Upload Course Schedule CSV</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="uploadBtn">Upload</button>

    <div id="columnSelect" style="margin-top: 1em;"></div>
    <div id="surveyContainer" style="margin-top: 2em;"></div>

    <script src="script.js"></script>
  </body>
</html>
EOF

# ðŸ§  script.js â€“ survey logic + CSV handling
cat <<'EOF' > script.js
let csvData = [];
let columnNames = [];

document.getElementById("uploadBtn").addEventListener("click", () => {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Please select a CSV file first!");

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      csvData = results.data;
      columnNames = results.meta.fields;
      showColumnSelector();
    }
  });
});

function showColumnSelector() {
  const container = document.getElementById("columnSelect");
  container.innerHTML = `
    <label>Display column:</label>
    <select id="displayCol">
      ${columnNames.map(col => `<option value="\${col}">\${col}</option>`).join("")}
    </select>

    <label style="margin-left: 1em;">UUID column:</label>
    <select id="uuidCol">
      ${columnNames.map(col => `<option value="\${col}">\${col}</option>`).join("")}
    </select>

    <button id="generateSurvey" style="margin-left: 1em;">Generate Survey</button>
  `;

  document.getElementById("generateSurvey").addEventListener("click", () => {
    const displayCol = document.getElementById("displayCol").value;
    const uuidCol = document.getElementById("uuidCol").value;
    generateSurvey(displayCol, uuidCol);
  });
}

function generateSurvey(displayCol, uuidCol) {
  const choices = csvData.map(row => ({
    value: row[uuidCol],
    text: row[displayCol]
  }));

  const surveyJson = {
    title: "Course Selection",
    questions: [
      {
        type: "dropdown",
        name: "selected_option",
        title: `Choose from column: \${displayCol}`,
        choices: choices
      }
    ]
  };

  const survey = new Survey.Model(surveyJson);

  survey.onComplete.add(sender => {
    const selectedUuid = sender.data.selected_option;
    const selectedRow = csvData.find(row => row[uuidCol] === selectedUuid);
    const displayText = selectedRow ? selectedRow[displayCol] : null;

    const payload = {
      uuid: selectedUuid,
      display_text: displayText,
      all_responses: sender.data
    };

    console.log("Survey Result:", payload);

    fetch("/api/survey", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  });

  document.getElementById("surveyContainer").innerHTML = "";
  $("#surveyContainer").Survey({ model: survey });
}
EOF

# ðŸ§  Example CSV for testing
cat <<'EOF' > example.csv
course_name,professor,ta,uuid
Intro to Econ,Dr. Smith,Alex Lee,uuid-001
Psychology 101,Dr. Patel,Jamie Wu,uuid-002
Statistics A,Dr. Nguyen,Chris Li,uuid-003
EOF

npm install
echo "âœ… Setup complete! Now click 'Run' in Replit to launch your app."